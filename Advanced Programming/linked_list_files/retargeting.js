!function(){if(window.mediaadRetargetingScriptLoaded)return;window.mediaadRetargetingScriptLoaded=!0;let sessionLifetime=18e5,uidKey="MEDIAAD_USER_ID";function store(t,e){localStorage.setItem(t,e)}function load(t){return localStorage.getItem(t)}function del(t){localStorage.removeItem(t)}function sendSessionData(t){store("ma-session:data",JSON.stringify(t)),del("ma-session:data")}function storeSyncedSessionData(t,e){sessionStorage.setItem(t,e);let n={};n[t]=e,sendSessionData(n)}function exportSessionData(){if(!sessionStorage.length)return;let t={},e;for(let n=0;n<sessionStorage.length;n++)(e=sessionStorage.key(n)).startsWith("ma-session:")&&(t[e]=sessionStorage.getItem(e));sendSessionData(t)}function importSessionData(t){let e=JSON.parse(t);for(let n in e){let i=e[n];null===i?sessionStorage.removeItem(n):sessionStorage.setItem(n,i)}}function getSessionStart(){let t=load("ma-session:start");return t?parseInt(t):0}function setSessionStart(t){store("ma-session:start",t)}function getSessionNumber(){let t=load("ma-session:num");return t?parseInt(t):-1}function incrementSessionNumber(){let t=getSessionNumber()+1;return store("ma-session:num",t),t}function getSessionEnd(){let t=load("ma-session:end");return t?parseInt(t):0}function expandSessionLifetime(t){store("ma-session:end",t+sessionLifetime)}function isNextSession(t,e){return e<=t||new Date(getSessionStart()).toLocaleDateString()!==new Date(t).toLocaleDateString()}function expandSession(){let t=Date.now(),e=getSessionEnd();expandSessionLifetime(t),isNextSession(t,e)&&(setSessionStart(t),informNewSession(incrementSessionNumber()))}function delSessionParams(){let t=[],e;for(let n=0;n<localStorage.length;n++)(e=localStorage.key(n)).startsWith("ma-session:")&&t.push(e);for(let i of t)del(i)}function doInSession(t,e){let n="ma-session:"+getSessionNumber()+":"+t;store(n,"1");try{e()}catch(i){console.log(i)}}function doOnceInSession(t,e){let n="ma-session:"+getSessionNumber()+":"+t;if(!load(n)){store(n,"1");try{e()}catch(i){console.log(i)}}}let eventMethod=window.addEventListener?"addEventListener":"attachEvent",eventer=window[eventMethod],storageEvent="attachEvent"===eventMethod?"onstorage":"storage";eventer(storageEvent,function(t){t||(t=window.event),t.newValue&&("ma-session:get"===t.key?exportSessionData():"ma-session:data"===t.key&&importSessionData(t.newValue))}),store("ma-session:get","1"),del("ma-session:get");let uidHolder={val:null,listeners:[],set value(val){for(this.val=val;this.listeners.length>0;)this.listeners.pop()(val)},get value(){if(this.val)return this.val;return this.val=load(uidKey),this.val},listen:function(t){this.listeners.push(t)}};function withUid(t){let e=uidHolder.value;if(e)try{t(e)}catch(n){console.log(n)}else uidHolder.listen(function(e){if(e)try{t(e)}catch(n){console.log(n)}})}let messageEvent="attachEvent"===eventMethod?"onmessage":"message";function extractUserIds(){function t(t){let e=t.match(/\/serve\/([^/]+)\/retargeting\.js/);return e?e[1]:null}let e,n=[];document.currentScript instanceof HTMLScriptElement&&(e=t(document.currentScript.src))&&n.push(e);let i=document.getElementsByTagName("script");for(let s=0;s<i.length;s++){let r=i.item(s);r&&r.src&&(e=t(r.src))&&n.push(e)}return n.filter((t,e,n)=>n.indexOf(t)===e)}function extractClickId(){let t;if("URLSearchParams"in window){if((t=new URLSearchParams(window.location.search)).has("utm_ma"))return t.get("utm_ma")}else if((t=window.location.search.substring(1).split("&").reduce(function(t,e){let n=e.split("="),i=n[0],s=decodeURIComponent(n[1]);return s=isNaN(Number(s))?s:Number(s),t[i]=s,t},{})).utm_ma)return t.utm_ma;return null}function docReady(t){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(t,1):document.addEventListener("DOMContentLoaded",t)}function getCurrentPath(){return decodeURIComponent(location.href.substr(location.origin.length))}function appendIframe(t){if(null==t)return;let e=document.createElement("iframe");e.style.display="none",e.src=t;try{document.body.appendChild(e)}catch(n){console.log(n)}}eventer(messageEvent,function(t){try{let e=t.data||t.message;if(null==e||void 0===e.indexOf)return;if(0===e.indexOf("mediaad-fid:")){var n=e.split(":")[1];uidHolder.value=n,store(uidKey,n,999)}}catch(i){console.log(i)}});let apiBaseUrl,userData={},matchIntervalCounter={},triggerIntervalCounter={},timeouts=[],currentPath=getCurrentPath();function checkUrlChange(){let t=getCurrentPath();t!==currentPath&&(currentPath=t,docReady(function(){setTimeout(refresh,2e3)}))}function refresh(){let t=timeouts.slice();timeouts=[];let e=0;0===t.length?processPage():t.forEach(function(n){clearTimeout(n),++e===t.length&&processPage()})}function processPage(){matchIntervalCounter={},triggerIntervalCounter={},Object.keys(userData).forEach(function(t){let e=userData[t];informPageLoaded(e),expandSession(),e.tags.forEach(function(t){testMatcherAsync(e,t,function(n){n&&applyTriggerEvent(e,t)})})})}function informPageLoaded(data){let matchedFeed,matchedCrawlers=[];if(data.crawlers)for(var i=0;i<data.crawlers.length;i++){let crawler=data.crawlers[i];if(matchedFeed&&crawler.feed_id!==matchedFeed)break;if(testMatcher(crawler)){let matched=!0;crawler.post_condition_code&&(matched=!0===eval(crawler.post_condition_code)),matched&&(matchedFeed=crawler.feed_id,matchedCrawlers.push(crawler.crawler_id))}}let pageUrl=location.href;withUid(function(t){let e={l:pageUrl};if(matchedCrawlers.length>0&&(e.p=1,e.c=matchedCrawlers.toString()),t){e.m=t;let n=load("_yngt"),i=load("sid");n&&(e.y=n),i&&(e.s=i)}postJson(apiUrl("/v2/events/page/loaded"),e,function(e){if(e&&e.length>0){let n="/v2/events/page/content?t="+e+"&l="+encodeURIComponent(pageUrl)+(matchedCrawlers.length>0?"&p=1&c="+matchedCrawlers.toString():"")+(t?"&fid="+t:"");import("https://mediacdn.mediaad.org/7/25/asset/js/pako_deflate.min.js").then(function(){let t;try{t=new Blob([pako.gzip(document.documentElement.outerHTML,{to:"string"})])}catch(e){console.log(e),t=new Blob([])}post(apiUrl(n),t,{"Content-Type":"application/octet-stream","Content-Encoding":"gzip"})})}})})}function informNewSession(t){let e=sessionStorage.getItem("ma-session:id");if(e){let n=location.href;postJson(apiUrl("/v1/events/post-back"),{clickId:e,actionName:"session-"+t,uri:n})}}function loadAttribsValues(t){let e={};return t.attribs&&t.attribs.forEach(function(n){e[n.id]=loadAttribValues(t,n)}),e}function loadAttribValues(tag,attrib){let vs;try{vs=eval(attrib.script)}catch(e){console.log(e)}if(!vs)return{};{let res={};return vs.forEach(function(t){res[t]?res[t]++:res[t]=1}),res}}function domainMatches(t){if(t.domain){let e=location.hostname;return e===t.domain||e==="www."+t.domain||"www."+e===t.domain}return!0}function testMatcher(t){return!!domainMatches(t)&&("equalsTo"===t.pattern_type?currentPath===t.query:"contains"===t.pattern_type?currentPath.includes(t.query):"startsWith"===t.pattern_type?currentPath.startsWith(t.query):"endsWith"===t.pattern_type?currentPath.endsWith(t.query):"regex"===t.pattern_type?RegExp(t.query).test(currentPath):"htmlElement"===t.pattern_type&&null!=(document.getElementById(t.query)||document.querySelector(t.query)))}function testMatcherAsync(t,e,n){if(!domainMatches(e)){n(!1);return}if("equalsTo"===e.pattern_type)n(currentPath===e.query);else if("contains"===e.pattern_type)n(currentPath.includes(e.query));else if("startsWith"===e.pattern_type)n(currentPath.startsWith(e.query));else if("endsWith"===e.pattern_type)n(currentPath.endsWith(e.query));else if("regex"===e.pattern_type)n(RegExp(e.query).test(currentPath));else if("htmlElement"===e.pattern_type){matchIntervalCounter[e.id]=0;let i=setInterval(function(){matchIntervalCounter[e.id]=matchIntervalCounter[e.id]+1;let s=null!=(document.getElementById(e.query)||document.querySelector(e.query));(s||matchIntervalCounter[e.id]>=t.max_interval_reset)&&(clearInterval(i),n(s))},1e3);timeouts.push(i)}}function applyTriggerEvent(data,tag){if("showPage"===tag.trigger_type)assignTagToUser(tag);else if("clickOnElement"===tag.trigger_type){tag.id in triggerIntervalCounter||(triggerIntervalCounter[tag.id]=0);let clickOnElementCheckInterval=setInterval(function(){triggerIntervalCounter[tag.id]=triggerIntervalCounter[tag.id]+1;let t=Array.prototype.slice.call(document.querySelectorAll(tag.css_selector));(t.length>0||triggerIntervalCounter[tag.id]>=data.max_interval_reset)&&clearInterval(clickOnElementCheckInterval),t.forEach(function(t){t.addEventListener("click",function(){assignTagToUser(tag)})})},1e3);timeouts.push(clickOnElementCheckInterval)}else if("submitForm"===tag.trigger_type){tag.id in triggerIntervalCounter||(triggerIntervalCounter[tag.id]=0);let submitFormCheckInterval=setInterval(function(){triggerIntervalCounter[tag.id]=triggerIntervalCounter[tag.id]+1;let t=Array.prototype.slice.call(document.querySelectorAll(tag.css_selector));(t.length>0||triggerIntervalCounter[tag.id]>=data.max_interval_reset)&&clearInterval(submitFormCheckInterval),t.forEach(function(t){t.addEventListener("submit",function(){assignTagToUser(tag)})})},1e3);timeouts.push(submitFormCheckInterval)}else if("timeToStay"===tag.trigger_type){let timeout=setTimeout(function(){assignTagToUser(tag)},1e3*tag.time_to_remain);timeouts.push(timeout)}else if("customScript"===tag.trigger_type)try{let result=eval(tag.custom_script);!0===result&&assignTagToUser(tag)}catch(e){console.log(e)}}function assignTagToUser(t){expandSession();let e=sessionStorage.getItem("ma-session:id");if(e){let n=location.href;doOnceInSession("pb:"+t.id,function(){postJson(apiUrl("/v1/events/post-back"),{clickId:e,actionName:t.title,uri:n})})}let i="tag:"+t.id,s=loadAttribsValues(t);Object.keys(s).length>0?doInSession(i,function(){withUid(function(n){postJson(apiUrl("/v1/events/tag?fid="+n+"&c="+!!e),{tagId:t.id,av:s})})}):doOnceInSession(i,function(){withUid(function(n){postJson(apiUrl("/v1/events/tag?fid="+n+"&c="+!!e),{tagId:t.id})})})}function apiUrl(t){return apiBaseUrl+t}function postJson(t,e,n){post(t,JSON.stringify(e),{"Content-Type":"application/json; charset=utf-8"},n)}function post(t,e,n,i){let s=new XMLHttpRequest;i&&(s.onreadystatechange=function(){s.readyState===XMLHttpRequest.DONE&&i(s.response)}),s.open("POST",t),s.withCredentials=!0,Object.entries(n).forEach(function(t){s.setRequestHeader(t[0],t[1])}),e?s.send(e):s.send()}function get(t,e){let n=new XMLHttpRequest;e&&(n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&e(n.response)}),n.open("GET",t),n.send(null)}docReady(function(){let t=extractUserIds();function e(n){if(n===t.length)appendIframe("https://mediacdn.mediaad.org/static/fingerprint.html"),setTimeout(function(){get(apiUrl("/v1/events/session/10"))},1e4),processPage(),setInterval(function(){checkUrlChange()},1e3);else{let i=t[n];get("https://ma-cdn.pegah.tech/v1/retargeting/"+i+"/advertiser.json",function(t){try{userData[i]=JSON.parse(t),apiBaseUrl=apiBaseUrl||userData[i].system_api_url}catch(s){console.log(s)}e(n+1)})}}if(t.length>0){let n=sessionStorage.getItem("ma-session:id"),i=extractClickId();i&&n!==i&&(delSessionParams(),storeSyncedSessionData("ma-session:id",i)),e(0)}})}();